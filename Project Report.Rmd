---
title: "Project-QM"
author: "Karan, Rohit, Shubham"
date: "14/03/2022"
output: pdf_document
---
### Introduction 
In this study, we have evaluated the impact of weather on retail sales in the major cities of Canada. We leveraged the data of 3 major retail players- Walmart, Costco and The Wholesale Food for analysing how the weather affects thei retail sales.  
1.Role of Data 
It is difficult to anticipate daily weather in advance but it has an immediate impact on daily business and sales.The use of weather forecasts to reduce demand uncertainty is restricted to retailers able to adjust their supply chain activities within two weeks. Retail sales being the downstream component of supply chain has 

1.1 Seasonality
Weather such as precipitation(snow and rain) can significantly influence shopper's decision. It is obscure how consumer will react to weather conditions, The shoppers may choose to use good weather as a reason for engaging in outdoor activities and thus postpone or forgo purchases. On the other hand they might consider shopping in clear and sunny weather. #Brick and Mortar
Holiday season can have pos
      
1.2. Psychological Effect
People in good mood are more likely to spend more money and self reward themselves.Weather can have negative effect on an individual's mood. 
Bad weather can have a negative psychological impact on shopper's willingness to visit retail stores. It might cause them to shop online or postpone the plan of shopping.  #BrickandMortar. Psychological effects may lead to a change in shopping habits, e.g., bulk buying to hoard supplies. For example, lower prices during an extreme weather occurrence might trigger stock-ups (Gauri et al., 2017). Lower prices during extreme weather occurrences are common in retail settings (Beutel and Minner, 2012). It has been shown that the weather at the time of purchase heavily affects customersâ€™ decisions for purchases, e.g., advance sales of outdoor events, when the weather at the time of purchase should be irrelevant. 

=======
1.Role of Weather 
  1.1. Seasonality  
  1.2. Psychological Effect

### Objective
The objective of this research paper is to analyze the impact of weather on retail sales in 3 major Canadian cities- Montreal, Toronto and Vancouver. 
2. Footfall is our proxy variable.
We are assessing the retail sales through the footfall data of stores which acts as our proxy variable. (Graham, 2017; Makkar, 2020). 

3. Weather Variables -> snow, precipitation, sunlight
### Literature Review
Weather impact on retail sales has been studied for more than 50 years now (Steele, 1951), but still there are only a handful of studies that provide sophisticated econometric analysis of weather effect. Starr-McCluer (2000) examined the effects of temperature on total US retail sales. #

1. Past Articles -1.1 and 1.2
2. How our research is novel?
3. How footfall is related to Sales?
4. Hypotheses : 3/4 depending on independent variables.
5. Control Variables and there importances--- refer to articles
    a. CPI b. unemployability c. disposable income d. consumer confidence 
Talk about all sections of paper- what's done in which section.

### Data Collection and preprocessing 
safegraph
statista.ca 
Python/ R preprocessing

# Data Preperation

## Part 1: Analysis of Monthly Retail Sales of Quebec, Ontario, and British columbia for the clothing and fashion industry

```{r, error=FALSE, include=FALSE}
#Import Libraries
library(tidyverse)
library(readxl)
library(ggcorrplot)
library(plm)
library(car)

retail_monthly = read.csv("Data/monthlyRetailSales.csv")
weather_monthly = read.csv("Data/monthlyWeather.csv")

retail_monthly <- retail_monthly %>% group_by(date) %>% summarize(British.Columbia=sum(British.Columbia),
                                                                    Ontario=sum(Ontario),
                                                                    Quebec=sum(Quebec))
retail_monthly <- retail_monthly %>% pivot_longer(!date, names_to = "prov", values_to = "sales")
retail_monthly <- retail_monthly %>% mutate(prov = case_when(prov == "British.Columbia" ~ "BC",
                                                             prov == "Ontario" ~ "ON",
                                                             prov == "Quebec" ~ "QC"))
retail_monthly <- retail_monthly %>% arrange(prov, date)

data_monthly <- merge(retail_monthly, weather_monthly, by = c("date", "prov"))
data_monthly$month <- substr(data_monthly$date,6,8)


cpi <- read_excel("Data/controlVariablesMonthly.xlsx", sheet="cpiIndex")
disposable_income <- read_excel("Data/controlVariablesMonthly.xlsx", sheet="disposableIncome")
unemployment_rate <- read_excel("Data/controlVariablesMonthly.xlsx", sheet="unemploymentRate")
consumer_confidence <- read_excel("Data/controlVariablesMonthly.xlsx", sheet="consumerConfidence")

control_data <- merge(cpi, consumer_confidence, by=c("date","prov"))
control_data <- merge(control_data, unemployment_rate, by=c("date","prov"))
control_data$year <- substr(control_data$date,1,4)
control_data <- merge(control_data, disposable_income, by=c("year","prov"), all.x=TRUE)

data_monthly <- merge(data_monthly, control_data, by=c("date","prov")) %>%
  select(date, year, month, prov, sales, max_temp, mean_temp, min_temp, spd_max_gust, total_precip, total_rain, total_snow, cpi_index, disposable_income, unemployment_rate, consumer_confidence) %>% arrange(prov,date)
```
## EDA: Retail Monthly
```{r}
#Correlation plot
corr<- round(cor(data_monthly[5:17]), 3)
ggcorrplot(corr)
```
```{r}
# Boxplot of sales
boxplot(sales~prov,
        data=data_monthly,
        xlab="Provinces", #adding labels
        ylab="Retail Sale")
```
```{r}
#Scatter plot of sales and total_snow
scatterplot(sales ~ total_snow, main="sales vs total_snow",
   xlab="Snowfall ", ylab="RetailSales ", data=data_monthly, pch=19)
```
```{r}
#Scatterplot of total_rain and sales
scatterplot(sales ~ total_rain, main="sales vs total_rain",
   xlab="Rainfall", ylab="RetailSales ", data=data_monthly, pch=19)
```
```{r}
# Histogram of sales
hist(data_monthly$sales,
     main="Retail Sale")
```
```{r}
hist(log(data_monthly$sales+1),
     main="Retail Sale")
```
Log transformation is thereby able to convert retail sales to closely resemble normal distribution. And we will be using log transformed y value in our models. 
```{r}
data_monthly$sales = log(data_monthly$sales+1)

#Since all predictors are in different scales, we are standardizing it to make it more interpretable.

data_monthly <- data_monthly %>% mutate_at(c("max_temp", "mean_temp", "min_temp", "spd_max_gust", "total_precip", "total_rain", "total_snow", "cpi_index", "disposable_income", "unemployment_rate", "consumer_confidence"), ~(scale(.) %>% as.vector))
```

```{r}
#IQR
IQR(data_monthly$sales)

summary(data_monthly)
```
```{r}
#Outlier Correction
for (col in colnames(data_monthly[3:10])){
  if data_
}
```
```{r}
#Model1: Pooled OLS model for the monthly data

base_model = lm(sales ~ consumer_confidence + cpi_index + disposable_income + unemployment_rate, data=data_monthly)
summary(base_model)
vif(base_model)

x = lm(sales ~ consumer_confidence + cpi_index + disposable_income + unemployment_rate + total_snow + total_rain + mean_temp + spd_max_gust,
       data = data_monthly)
summary(x)


m2 = plm(sales ~ consumer_confidence + cpi_index + disposable_income + unemployment_rate + total_snow + total_rain + mean_temp + spd_max_gust, index=c("prov","date"), data=data_monthly, model="within")
summary(m2)

m3 = plm(sales ~ cpi_index + unemployment_rate + total_snow + total_rain + mean_temp, index=c("prov","date"), data=data_monthly, model="within")
summary(m3)

m4 = plm(sales ~ total_snow + total_rain + mean_temp, index=c("prov","date"), data=data_monthly, model="within")
summary(m4)

m5 = 


lm.full = lm(sales ~ ., data = data_monthly[5:16])
lm1 = step(lm.full, direction = "backward")
summary(lm1)

vif(lm1)

x1 = lm(sales ~ total_precip + total_snow + cpi_index + disposable_income + unemployment_rate, data = data_monthly)
summary(x1)
vif(x1)

#### BEST MODEL FOR US I THINK 
t2 = lm(sales ~ I(max_temp^2) + total_rain + total_snow + unemployment_rate, data =data_monthly)
summary(t2)
vif(t2)
####

plot(density(resid(x1)))
plot(fitted(t2), resid(x1))

```

#Using PCA
```{r}
library("FactoMineR")
library("factoextra")
res.pca <- PCA(data_monthly[5:16],  graph = FALSE)
get_eig(res.pca)

t2 = lm(data_monthly$sales ~ res.pca[4]$svd$U[,1:4])
summary(t2)

plot(density(resid(t2)))
plot(fitted(t2), resid(t2))

m1 = lm(sales ~ spd_max_gust, data=data_monthly)
summary(m1)

m2 = lm(sales ~ total_rain, data=data_monthly)
summary(m2)

m3 = lm(sales ~ total_snow, data=data_monthly)
summary(m3)

m4 = lm(sales ~ total_snow + total_rain + spd_max_gust, data=data_monthly)
summary(m4)

m5 = lm(sales ~ total_snow + total_rain  , data=data_monthly)
summary(m5)


vif(m5)

  #Model2: LSDV for the monthly data - add dummy variables for prov

lm.full = lm(sales ~ ., data = data_monthly[2:10])
lm2 = step(lm.full, direction = "backward")
summary(lm2)

t1 = lm(sales ~ spd_max_gust + total_rain + total_snow, data=data_monthly)
summary(t1)
vif(t1)

vif(lm2)
#Model3: 
lm3 = lm(sales ~ prov + mean_temp + spd_max_gust + total_precip + total_rain, data = data_monthly)
summary(lm3)

#Model4:
lm4 = lm(sales ~ prov + total_snow + spd_max_gust + total_precip + total_rain, data = data_monthly)
summary(lm4)

#Model5:
plm1 = plm(sales ~ total_snow + spd_max_gust + total_rain + month, data = data_monthly,
           index=c("prov","date"), model = "pooling")
summary(plm1)

plm2 = plm(sales ~ total_snow + spd_max_gust + total_rain, data = data_monthly,
           index=c("prov","date"), model = "random", random.method = "amemiya")
summary(plm2)


t1 = lm(sales ~ total_snow + spd_max_gust + total_rain , data=data_monthly)
summary(t1)
#Model6:
plm2 = plm(sales ~ total_snow + spd_max_gust  + total_precip + total_rain + prov, data = data_monthly, model = "random")
summary(plm2)

phtest(plm1, plm2)



```
### Results


### Conclusion